<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - FaceAccess</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="light">
    <div class="admin-container">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon"><i class="fas fa-fingerprint"></i></div>
                    <span class="logo-text">FaceAccess</span>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a class="nav-item active" data-page="dashboard" data-tooltip="Dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a class="nav-item" data-page="users" data-tooltip="Utilisateurs">
                    <i class="fas fa-users"></i>
                    <span>Utilisateurs</span>
                </a>
                <a class="nav-item" data-page="logs" data-tooltip="Logs d'accès">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Logs d'accès</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div class="user-details">
                        <span>Admin</span>
                        <small>Administrateur</small>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <h1><i class="fas fa-grip-horizontal"></i> <span id="page-title">Dashboard</span></h1>
                </div>
                <div class="topbar-right">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- DASHBOARD -->
                <div id="page-dashboard" class="page active">
                    <!-- KPI Cards Row 1 -->
                    <div class="stats-grid">
                        <div class="stat-card blue">
                            <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-users">0</h3>
                                <p>Utilisateurs totaux</p>
                            </div>
                        </div>
                        <div class="stat-card green">
                            <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-active">0</h3>
                                <p>Utilisateurs actifs</p>
                            </div>
                        </div>
                        <div class="stat-card orange">
                            <div class="stat-icon orange"><i class="fas fa-id-badge"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-profiles">0</h3>
                                <p>Profils faciaux</p>
                            </div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-icon purple"><i class="fas fa-door-open"></i></div>
                            <div class="stat-info">
                                <h3 id="stat-access">0</h3>
                                <p>Accès totaux</p>
                            </div>
                        </div>
                    </div>

                    <!-- Graphiques Row -->
                    <div class="charts-grid charts-grid-2">
                        <!-- Graphique circulaire : GRANTED/DENIED -->
                        <div class="card chart-card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-pie"></i> Répartition GRANTED/DENIED</h3>
                            </div>
                            <div class="card-body chart-body-small">
                                <canvas id="chart-results"></canvas>
                                <div class="chart-legend" id="legend-results"></div>
                            </div>
                        </div>
                        
                        <!-- Graphique : Méthodes -->
                        <div class="card chart-card">
                            <div class="card-header">
                                <h3><i class="fas fa-fingerprint"></i> Méthodes d'accès</h3>
                            </div>
                            <div class="card-body chart-body-small">
                                <canvas id="chart-methods"></canvas>
                                <div class="chart-legend" id="legend-methods"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Taux de réussite + Alertes -->
                    <div class="dashboard-row">
                        <!-- Taux de réussite -->
                        <div class="card success-rate-card">
                            <div class="card-header">
                                <h3><i class="fas fa-percentage"></i> Taux de réussite</h3>
                            </div>
                            <div class="card-body">
                                <div class="success-rate-container">
                                    <div class="success-rate-circle">
                                        <svg viewBox="0 0 36 36">
                                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                            <path class="circle-progress" id="success-circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                        </svg>
                                        <div class="success-rate-text">
                                            <span id="success-rate-value">0</span>%
                                        </div>
                                    </div>
                                    <div class="success-rate-details">
                                        <div class="rate-item granted">
                                            <i class="fas fa-check"></i>
                                            <span><strong id="total-granted">0</strong> accordés</span>
                                        </div>
                                        <div class="rate-item denied">
                                            <i class="fas fa-times"></i>
                                            <span><strong id="total-denied">0</strong> refusés</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alertes de sécurité -->
                        <div class="card alerts-card">
                            <div class="card-header danger-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Alertes de sécurité</h3>
                                <span class="alert-count" id="alert-count">0</span>
                            </div>
                            <div class="card-body">
                                <div class="alerts-list" id="alerts-list">
                                    <div class="no-alerts">
                                        <i class="fas fa-shield-alt"></i>
                                        <p>Aucune alerte récente</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activité récente -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Activité récente</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-user"></i> Utilisateur</th>
                                            <th><i class="fas fa-shield-alt"></i> Résultat</th>
                                            <th><i class="fas fa-fingerprint"></i> Méthode</th>
                                            <th><i class="fas fa-clock"></i> Date/Heure</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="dashboard-pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- USERS -->
                <div id="page-users" class="page">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label><i class="fas fa-search"></i> Rechercher:</label>
                            <input type="text" id="user-search" placeholder="Nom ou email...">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="filterUsers()"><i class="fas fa-filter"></i> Filtrer</button>
                            <button class="btn btn-secondary" onclick="resetUserFilters()"><i class="fas fa-redo"></i> Reset</button>
                            <button class="btn btn-success" onclick="openAddUserModal()"><i class="fas fa-user-plus"></i> Ajouter</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><h3><i class="fas fa-users-cog"></i> Gestion des utilisateurs</h3></div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-hashtag"></i> ID</th>
                                            <th><i class="fas fa-user"></i> Username</th>
                                            <th><i class="fas fa-envelope"></i> Email</th>
                                            <th><i class="fas fa-user-tag"></i> Rôle</th>
                                            <th><i class="fas fa-toggle-on"></i> Statut</th>
                                            <th><i class="fas fa-calendar-plus"></i> Créé le</th>
                                            <th><i class="fas fa-camera"></i> Profil</th>
                                            <th><i class="fas fa-cogs"></i> Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="users-pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- LOGS -->
                <div id="page-logs" class="page">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label><i class="fas fa-user"></i> Username:</label>
                            <input type="text" id="log-username" placeholder="Rechercher...">
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-check-double"></i> Résultat:</label>
                            <select id="log-result">
                                <option value="">Tous</option>
                                <option value="GRANTED">✓ GRANTED</option>
                                <option value="DENIED">✗ DENIED</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-calendar"></i> Date:</label>
                            <input type="date" id="log-date">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="filterLogs()"><i class="fas fa-filter"></i> Filtrer</button>
                            <button class="btn btn-secondary" onclick="resetLogFilters()"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-history"></i> Historique des accès</h3>
                            <button class="btn btn-sm btn-info" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Rafraîchir</button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-hashtag"></i> ID</th>
                                            <th><i class="fas fa-user"></i> Utilisateur</th>
                                            <th><i class="fas fa-shield-alt"></i> Résultat</th>
                                            <th><i class="fas fa-fingerprint"></i> Méthode</th>
                                            <th><i class="fas fa-clock"></i> Date/Heure</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logs-table"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="logs-pagination"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="user-modal">
        <div class="modal modal-large">
            <div class="modal-header">
                <i class="fas fa-user-edit"></i>
                <h3 id="modal-title">Modifier l'utilisateur</h3>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-user-id">
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Username *</label>
                        <input type="text" id="edit-username" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="edit-email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user-tag"></i> Rôle *</label>
                        <select id="edit-role">
                            <option value="USER">USER</option>
                            <option value="ADMIN">ADMIN</option>
                            <option value="GUEST">GUEST</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-toggle-on"></i> Statut</label>
                        <select id="edit-status">
                            <option value="true">Actif</option>
                            <option value="false">Inactif</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Mot de passe *</label>
                    <input type="password" id="edit-password">
                    <p class="form-hint" id="password-hint">Laisser vide pour ne pas modifier</p>
                </div>
                
                <!-- Section Photo - OBLIGATOIRE pour nouveaux utilisateurs -->
                <div class="photo-section" id="photo-section">
                    <div class="photo-header">
                        <i class="fas fa-camera"></i>
                        <span>Photo du visage <strong style="color:#e74c3c">(OBLIGATOIRE)</strong></span>
                    </div>
                    <div class="photo-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        La photo est obligatoire pour extraire les embeddings faciaux
                    </div>
                    <div class="photo-container">
                        <div class="webcam-container">
                            <video id="webcam-video" autoplay playsinline></video>
                            <canvas id="capture-canvas" style="display:none;"></canvas>
                            <div class="webcam-overlay" id="webcam-overlay">
                                <i class="fas fa-video-slash"></i>
                                <span>Caméra inactive</span>
                            </div>
                        </div>
                        <div class="photo-preview-container">
                            <div class="photo-preview" id="photo-preview">
                                <i class="fas fa-user-circle"></i>
                                <span>Aucune photo</span>
                            </div>
                            <div class="extraction-status" id="extraction-status"></div>
                        </div>
                    </div>
                    <div class="photo-actions">
                        <button type="button" class="btn btn-info" onclick="startWebcam()">
                            <i class="fas fa-video"></i> Webcam
                        </button>
                        <button type="button" class="btn btn-primary" onclick="capturePhoto()" id="btn-capture" disabled>
                            <i class="fas fa-camera"></i> Capturer
                        </button>
                        <label class="btn btn-warning" style="cursor:pointer;margin:0;">
                            <i class="fas fa-folder-open"></i> Parcourir
                            <input type="file" id="photo-file-input" accept="image/*" onchange="loadPhotoFromFile(event)" style="display:none;">
                        </label>
                        <button type="button" class="btn btn-secondary" onclick="resetPhoto()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()"><i class="fas fa-times"></i> Annuler</button>
                <button class="btn btn-success" onclick="saveUser()"><i class="fas fa-save"></i> Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header danger">
                <i class="fas fa-trash-alt"></i>
                <h3>Supprimer l'utilisateur</h3>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p>Supprimer <strong id="delete-username"></strong> ?</p>
                <p style="color:var(--text-muted);font-size:12px;margin-top:8px;">Cette action est irréversible.</p>
                <input type="hidden" id="delete-user-id">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>


    <style>
        /* Stats Grid 3 colonnes */
        .stats-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .stat-card.teal::before { background: #14b8a6; }
        .stat-icon.teal { background: rgba(20, 184, 166, 0.15); color: #14b8a6; }
        .stat-card.success::before { background: #10b981; }
        .stat-icon.success { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .stat-card.danger::before { background: #ef4444; }
        .stat-icon.danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .charts-grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        .chart-card { min-height: 280px; }
        .chart-card .card-body { padding: 16px; height: 220px; }
        .chart-body-small { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
        }
        .chart-body-small canvas { max-height: 160px; }
        .chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 12px;
        }
        .chart-legend span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chart-legend .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Dashboard Row */
        .dashboard-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Success Rate Card */
        .success-rate-card .card-body { padding: 24px; }
        .success-rate-container {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .success-rate-circle {
            position: relative;
            width: 120px;
            height: 120px;
        }
        .success-rate-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .circle-bg {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 3;
        }
        .circle-progress {
            fill: none;
            stroke: #10b981;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease;
        }
        .success-rate-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .success-rate-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .rate-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
        }
        .rate-item.granted {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        .rate-item.denied {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Alerts Card */
        .alerts-card { max-height: 320px; }
        .danger-header {
            background: linear-gradient(135deg, #ef4444, #f87171) !important;
            color: white;
        }
        .danger-header h3 { color: white; }
        .danger-header h3 i { background: rgba(255,255,255,0.2); color: white; }
        .alert-count {
            background: white;
            color: #ef4444;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
        }
        .alerts-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-primary);
            margin-bottom: 8px;
            border-left: 4px solid #ef4444;
            animation: fadeIn 0.3s ease;
        }
        .alert-item i {
            color: #ef4444;
            font-size: 18px;
        }
        .alert-item .alert-info {
            flex: 1;
        }
        .alert-item .alert-info strong {
            display: block;
            font-size: 13px;
            color: var(--text-primary);
        }
        .alert-item .alert-info small {
            color: var(--text-muted);
            font-size: 11px;
        }
        .no-alerts {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        .no-alerts i {
            font-size: 40px;
            margin-bottom: 12px;
            color: #10b981;
        }

        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
            .dashboard-row { grid-template-columns: 1fr; }
            .stats-grid-3 { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .stats-grid-3 { grid-template-columns: 1fr; }
        }

        /* Modal large pour ajout utilisateur */
        .modal-large { 
            max-width: 600px; 
            width: 95%; 
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-large .modal-body {
            overflow-y: auto;
            max-height: calc(90vh - 160px);
            padding: 20px;
        }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; min-width: 0; }
        .form-group { margin-bottom: 14px; }
        .form-group input, .form-group select { padding: 10px 14px; font-size: 14px; }
        
        /* Section Photo */
        .photo-section {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }
        .photo-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        .photo-header i { color: var(--primary); font-size: 18px; }
        .photo-warning {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .photo-container {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .webcam-container {
            position: relative;
            width: 200px;
            height: 150px;
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .webcam-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .webcam-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.8);
            color: #888;
            gap: 8px;
            font-size: 12px;
        }
        .webcam-overlay i { font-size: 30px; }
        .webcam-overlay.hidden { display: none; }
        .photo-preview-container { flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 8px; }
        .photo-preview {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            min-height: 100px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .photo-preview i { font-size: 36px; margin-bottom: 6px; }
        .photo-preview span { font-size: 12px; }
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-preview.has-photo { padding: 0; }
        .extraction-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            display: none;
        }
        .extraction-status.loading {
            display: block;
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        .extraction-status.success {
            display: block;
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        .extraction-status.error {
            display: block;
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        .photo-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .photo-actions .btn { 
            padding: 8px 14px; 
            font-size: 13px;
        }
        .btn-info { background: #3498db; color: white; }
        .btn-info:hover { background: #2980b9; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        
        /* Responsive modal */
        @media (max-width: 600px) {
            .modal-large { max-width: 98%; }
            .form-row { flex-direction: column; gap: 0; }
            .photo-container { flex-direction: column; align-items: center; }
            .webcam-container { width: 100%; max-width: 250px; }
            .photo-preview-container { width: 100%; }
        }
    </style>

    <script>
        let allUsers = [];
        let allLogs = [];
        const ITEMS_PER_PAGE = 20;
        let currentPageDashboard = 1;
        let currentPageLogs = 1;
        let currentPageUsers = 1;
        
        // Variables pour la capture photo
        let webcamStream = null;
        let capturedImageData = null;
        let extractedEmbeddings = null;
        let isNewUser = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            setupNavigation();
            const theme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }

        function toggleTheme() {
            const theme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('theme-icon').className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(`page-${page}`).classList.add('active');
                    document.getElementById('page-title').textContent = 
                        page === 'dashboard' ? 'Dashboard' : 
                        page === 'users' ? 'Gestion des utilisateurs' : 'Historique des accès';
                });
            });
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function loadAllData() {
            try {
                const [usersRes, logsRes] = await Promise.all([
                    fetch('/api/users'),
                    fetch('/api/logs')
                ]);
                allUsers = await usersRes.json();
                allLogs = await logsRes.json();
                
                console.log('Users loaded:', allUsers.length);
                console.log('Logs loaded:', allLogs.length);
                
                updateStats();
                renderDashboardActivity();
                renderUsers(allUsers);
                renderLogs(allLogs);
            } catch (e) {
                console.error('Load error:', e);
                showToast('Erreur de chargement', 'error');
            }
        }

        function updateStats() {
            // Stats de base
            document.getElementById('stat-users').textContent = allUsers.length;
            document.getElementById('stat-active').textContent = allUsers.filter(u => u.is_active).length;
            document.getElementById('stat-profiles').textContent = allUsers.filter(u => u.has_profile).length;
            document.getElementById('stat-access').textContent = allLogs.length;
            
            // Taux de réussite
            const totalGranted = allLogs.filter(log => log.access_result === 'GRANTED').length;
            const totalDenied = allLogs.filter(log => log.access_result === 'DENIED').length;
            const successRate = allLogs.length > 0 ? Math.round((totalGranted / allLogs.length) * 100) : 0;
            
            document.getElementById('success-rate-value').textContent = successRate;
            document.getElementById('success-circle').setAttribute('stroke-dasharray', `${successRate}, 100`);
            document.getElementById('total-granted').textContent = totalGranted;
            document.getElementById('total-denied').textContent = totalDenied;
            
            // Alertes de sécurité (derniers accès refusés)
            renderAlerts();
            
            // Graphiques
            renderCharts();
        }
        
        function renderAlerts() {
            const deniedLogs = allLogs.filter(log => log.access_result === 'DENIED').slice(0, 5);
            const alertsList = document.getElementById('alerts-list');
            const alertCount = document.getElementById('alert-count');
            
            alertCount.textContent = deniedLogs.length;
            
            if (deniedLogs.length === 0) {
                alertsList.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-shield-alt"></i>
                        <p>Aucune alerte récente</p>
                    </div>
                `;
            } else {
                alertsList.innerHTML = deniedLogs.map(log => `
                    <div class="alert-item">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="alert-info">
                            <strong>Accès refusé - ${log.username || 'Inconnu'}</strong>
                            <small>${log.access_method} • ${formatDateTime(log.access_time)}</small>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        let chartResults, chartMethods;
        
        function renderCharts() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            // Graphique circulaire - GRANTED/DENIED
            const totalGranted = allLogs.filter(log => log.access_result === 'GRANTED').length;
            const totalDenied = allLogs.filter(log => log.access_result === 'DENIED').length;
            
            const ctxResults = document.getElementById('chart-results').getContext('2d');
            if (chartResults) chartResults.destroy();
            chartResults = new Chart(ctxResults, {
                type: 'doughnut',
                data: {
                    labels: ['Accordés', 'Refusés'],
                    datasets: [{
                        data: [totalGranted, totalDenied],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            document.getElementById('legend-results').innerHTML = `
                <span><span class="dot" style="background:#10b981"></span> Accordés (${totalGranted})</span>
                <span><span class="dot" style="background:#ef4444"></span> Refusés (${totalDenied})</span>
            `;
            
            // Graphique - Méthodes
            const faceOnly = allLogs.filter(log => log.access_method === 'FACE_ONLY').length;
            const pinOnly = allLogs.filter(log => log.access_method === 'PIN_ONLY').length;
            
            const ctxMethods = document.getElementById('chart-methods').getContext('2d');
            if (chartMethods) chartMethods.destroy();
            chartMethods = new Chart(ctxMethods, {
                type: 'doughnut',
                data: {
                    labels: ['Face', 'PIN'],
                    datasets: [{
                        data: [faceOnly, pinOnly],
                        backgroundColor: ['#6366f1', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            document.getElementById('legend-methods').innerHTML = `
                <span><span class="dot" style="background:#6366f1"></span> Face (${faceOnly})</span>
                <span><span class="dot" style="background:#f59e0b"></span> PIN (${pinOnly})</span>
            `;
        }

        // ==================== PAGINATION ====================
        function paginate(data, page) {
            const start = (page - 1) * ITEMS_PER_PAGE;
            return data.slice(start, start + ITEMS_PER_PAGE);
        }

        function renderPagination(containerId, totalItems, currentPage, onPageChange) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const container = document.getElementById(containerId);
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            
            let html = `<button ${currentPage === 1 ? 'disabled' : ''} onclick="${onPageChange}(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span style="padding:0 8px;color:var(--text-muted)">...</span>`;
                }
            }
            
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="${onPageChange}(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            html += `<span class="pagination-info">${totalItems} éléments</span>`;
            container.innerHTML = html;
        }

        // ==================== DASHBOARD ====================
        function renderDashboardActivity() {
            const data = paginate(allLogs, currentPageDashboard);
            document.getElementById('recent-activity').innerHTML = data.map(log => `
                <tr>
                    <td><strong>${log.username || 'Inconnu'}</strong></td>
                    <td><span class="badge badge-${log.access_result === 'GRANTED' ? 'success' : 'danger'}">${log.access_result}</span></td>
                    <td><span class="badge badge-${log.access_method === 'FACE_ONLY' ? 'info' : 'secondary'}">${log.access_method}</span></td>
                    <td>${formatDateTime(log.access_time)}</td>
                </tr>
            `).join('');
            renderPagination('dashboard-pagination', allLogs.length, currentPageDashboard, 'goToDashboardPage');
        }

        function goToDashboardPage(page) {
            currentPageDashboard = page;
            renderDashboardActivity();
        }

        // ==================== USERS ====================
        function renderUsers(users) {
            const data = paginate(users, currentPageUsers);
            document.getElementById('users-table').innerHTML = data.map(u => `
                <tr>
                    <td>#${u.id}</td>
                    <td><strong>${u.username}</strong></td>
                    <td>${u.email || '-'}</td>
                    <td><span class="badge badge-${u.role === 'ADMIN' ? 'warning' : 'info'}">${u.role}</span></td>
                    <td><span class="status-check ${u.is_active ? 'active' : 'inactive'}"><i class="fas fa-${u.is_active ? 'check' : 'times'}-circle"></i> ${u.is_active ? 'Actif' : 'Inactif'}</span></td>
                    <td>${formatDate(u.created_at)}</td>
                    <td><span class="profile-badge ${u.has_profile ? 'yes' : 'no'}"><i class="fas fa-${u.has_profile ? 'check' : 'times'}"></i></span></td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-icon" onclick="editUser(${u.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger btn-icon" onclick="deleteUser(${u.id}, '${u.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            renderPagination('users-pagination', users.length, currentPageUsers, 'goToUsersPage');
        }

        function goToUsersPage(page) {
            currentPageUsers = page;
            renderUsers(allUsers);
        }

        // ==================== LOGS ====================
        let filteredLogs = [];
        
        function renderLogs(logs) {
            filteredLogs = logs;
            const data = paginate(logs, currentPageLogs);
            document.getElementById('logs-table').innerHTML = data.map(log => `
                <tr>
                    <td>#${log.id}</td>
                    <td><strong>${log.username || 'Inconnu'}</strong></td>
                    <td><span class="badge badge-${log.access_result === 'GRANTED' ? 'success' : 'danger'}">${log.access_result}</span></td>
                    <td><span class="badge badge-${log.access_method === 'FACE_ONLY' ? 'info' : 'secondary'}">${log.access_method}</span></td>
                    <td>${formatDateTime(log.access_time)}</td>
                </tr>
            `).join('');
            renderPagination('logs-pagination', logs.length, currentPageLogs, 'goToLogsPage');
        }

        function goToLogsPage(page) {
            currentPageLogs = page;
            renderLogs(filteredLogs);
        }

        function renderScore(score) {
            if (!score) return '<span style="color:var(--text-muted)">-</span>';
            const pct = Math.round(score * 100);
            const lvl = pct >= 60 ? 'high' : pct >= 40 ? 'medium' : 'low';
            return `<div class="score-display"><div class="score-bar"><div class="score-bar-fill ${lvl}" style="width:${pct}%"></div></div><span class="score-text">${pct}%</span></div>`;
        }

        // ==================== FILTERS ====================
        function filterUsers() {
            const search = document.getElementById('user-search').value.toLowerCase();
            currentPageUsers = 1;
            renderUsers(allUsers.filter(u => !search || u.username.toLowerCase().includes(search) || (u.email && u.email.toLowerCase().includes(search))));
        }

        function resetUserFilters() {
            document.getElementById('user-search').value = '';
            currentPageUsers = 1;
            renderUsers(allUsers);
        }

        function filterLogs() {
            const username = document.getElementById('log-username').value.toLowerCase();
            const result = document.getElementById('log-result').value;
            const date = document.getElementById('log-date').value;
            currentPageLogs = 1;
            renderLogs(allLogs.filter(log => {
                return (!username || (log.username && log.username.toLowerCase().includes(username))) &&
                       (!result || log.access_result === result) &&
                       (!date || (log.access_time && log.access_time.startsWith(date)));
            }));
        }

        function resetLogFilters() {
            document.getElementById('log-username').value = '';
            document.getElementById('log-result').value = '';
            document.getElementById('log-date').value = '';
            currentPageLogs = 1;
            renderLogs(allLogs);
        }

        // ==================== WEBCAM & PHOTO CAPTURE ====================
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: 'user' } 
                });
                const video = document.getElementById('webcam-video');
                video.srcObject = webcamStream;
                document.getElementById('webcam-overlay').classList.add('hidden');
                document.getElementById('btn-capture').disabled = false;
                showToast('Caméra démarrée', 'success');
            } catch (e) {
                console.error('Erreur webcam:', e);
                showToast('Impossible d\'accéder à la caméra', 'error');
            }
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            document.getElementById('webcam-video').srcObject = null;
            document.getElementById('webcam-overlay').classList.remove('hidden');
            document.getElementById('btn-capture').disabled = true;
        }

        async function capturePhoto() {
            const video = document.getElementById('webcam-video');
            const canvas = document.getElementById('capture-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            ctx.drawImage(video, 0, 0);
            
            // Afficher la preview
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            capturedImageData = imageData;
            
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = `<img src="${imageData}" alt="Photo capturée">`;
            preview.classList.add('has-photo');
            
            // Extraire les embeddings
            await extractEmbeddings(imageData);
        }

        async function extractEmbeddings(imageData) {
            const status = document.getElementById('extraction-status');
            status.className = 'extraction-status loading';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extraction des embeddings en cours...';
            
            try {
                const res = await fetch('/api/users/extract_embeddings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                const result = await res.json();
                
                if (result.status === 'success') {
                    extractedEmbeddings = result.embeddings;
                    status.className = 'extraction-status success';
                    status.innerHTML = `<i class="fas fa-check-circle"></i> Embeddings extraits avec succès ! (${result.count} caractéristiques)`;
                    showToast('Visage détecté et embeddings extraits', 'success');
                } else {
                    extractedEmbeddings = null;
                    status.className = 'extraction-status error';
                    status.innerHTML = `<i class="fas fa-times-circle"></i> ${result.message}`;
                    showToast(result.message, 'error');
                }
            } catch (e) {
                extractedEmbeddings = null;
                status.className = 'extraction-status error';
                status.innerHTML = '<i class="fas fa-times-circle"></i> Erreur de connexion au serveur';
                showToast('Erreur extraction', 'error');
            }
        }

        function resetPhoto() {
            capturedImageData = null;
            extractedEmbeddings = null;
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = '<i class="fas fa-user-circle"></i><span>Aucune photo</span>';
            preview.classList.remove('has-photo');
            document.getElementById('extraction-status').className = 'extraction-status';
            document.getElementById('extraction-status').innerHTML = '';
            document.getElementById('photo-file-input').value = '';
        }

        async function loadPhotoFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Vérifier le type de fichier
            if (!file.type.startsWith('image/')) {
                showToast('Veuillez sélectionner une image', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                capturedImageData = imageData;
                
                // Afficher la preview
                const preview = document.getElementById('photo-preview');
                preview.innerHTML = `<img src="${imageData}" alt="Photo sélectionnée">`;
                preview.classList.add('has-photo');
                
                // Extraire les embeddings
                await extractEmbeddings(imageData);
            };
            reader.readAsDataURL(file);
        }

        async function refreshData() {
            showToast('Rafraîchissement en cours...', 'success');
            await loadAllData();
            showToast('Données rafraîchies', 'success');
        }

        // ==================== USER CRUD ====================
        function openAddUserModal() {
            isNewUser = true;
            document.getElementById('modal-title').textContent = 'Ajouter un utilisateur';
            document.getElementById('edit-user-id').value = '';
            document.getElementById('edit-username').value = '';
            document.getElementById('edit-email').value = '';
            document.getElementById('edit-role').value = 'USER';
            document.getElementById('edit-status').value = 'true';
            document.getElementById('edit-password').value = '';
            document.getElementById('password-hint').textContent = 'Mot de passe obligatoire';
            
            // Afficher la section photo et réinitialiser
            document.getElementById('photo-section').style.display = 'block';
            resetPhoto();
            
            document.getElementById('user-modal').classList.add('active');
        }

        function editUser(id) {
            isNewUser = false;
            const user = allUsers.find(u => u.id === id);
            if (!user) return;
            document.getElementById('modal-title').textContent = 'Modifier l\'utilisateur';
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-role').value = user.role;
            document.getElementById('edit-status').value = user.is_active ? 'true' : 'false';
            document.getElementById('edit-password').value = '';
            document.getElementById('password-hint').textContent = 'Laisser vide pour ne pas modifier';
            
            // Cacher la section photo pour modification (profil déjà existant ou non)
            document.getElementById('photo-section').style.display = user.has_profile ? 'none' : 'block';
            resetPhoto();
            
            document.getElementById('user-modal').classList.add('active');
        }

        function closeModal() { 
            stopWebcam();
            resetPhoto();
            document.getElementById('user-modal').classList.remove('active'); 
        }

        async function saveUser() {
            const id = document.getElementById('edit-user-id').value;
            const username = document.getElementById('edit-username').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const role = document.getElementById('edit-role').value;
            const isActive = document.getElementById('edit-status').value === 'true';
            const password = document.getElementById('edit-password').value;
            
            // Validations
            if (!username) {
                showToast('Le nom d\'utilisateur est obligatoire', 'error');
                return;
            }
            
            // Pour un nouvel utilisateur
            if (!id) {
                if (!password) {
                    showToast('Le mot de passe est obligatoire', 'error');
                    return;
                }
                if (!extractedEmbeddings) {
                    showToast('⚠️ La photo du visage est OBLIGATOIRE ! Veuillez capturer une photo.', 'error');
                    return;
                }
            }
            
            const data = {
                username: username,
                email: email || null,
                role: role,
                is_active: isActive
            };
            if (password) data.password = password;
            if (!id && extractedEmbeddings) {
                data.embeddings = extractedEmbeddings;
                data.image_data = capturedImageData;
            }
            
            try {
                const res = await fetch(id ? `/api/users/${id}` : '/api/users', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast(id ? 'Utilisateur modifié' : 'Utilisateur créé avec profil facial');
                    closeModal();
                    loadAllData();
                } else {
                    showToast(result.message || 'Erreur', 'error');
                }
            } catch (e) { 
                console.error(e);
                showToast('Erreur', 'error'); 
            }
        }

        function deleteUser(id, username) {
            document.getElementById('delete-user-id').value = id;
            document.getElementById('delete-username').textContent = username;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('active'); }

        async function confirmDelete() {
            const id = document.getElementById('delete-user-id').value;
            try {
                const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                if ((await res.json()).status === 'success') {
                    showToast('Utilisateur supprimé');
                    closeDeleteModal();
                    loadAllData();
                }
            } catch (e) { showToast('Erreur', 'error'); }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        }

        function formatDate(d) { return d ? d.split('T')[0].split(' ')[0] : '-'; }
        function formatDateTime(d) {
            if (!d) return '-';
            try { return new Date(d).toLocaleString('fr-FR'); } catch { return d; }
        }
    </script>
</body>
</html>
